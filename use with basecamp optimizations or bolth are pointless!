// ==UserScript==
// @name         Basecamp optimizations unmerget testing
// @namespace    http://tampermonkey.net/
// @version      46.0
// @description  E
// @author       WOB
// @match        https://g.myascendmath.com/*
// @grant        none
// @run-at       document-start
// ==/UserScript==

(function() {
    'use strict';

    
    const boostFPS = () => {
        if (window.createjs && window.createjs.Ticker) {
            window.createjs.Ticker.framerate = 80;
            window.createjs.Ticker.setFPS(80);
            window.createjs.Ticker.timingMode = window.createjs.Ticker.RAF;
        }
    };


    // Instead of a loop, we define these once.
    const noop = () => false;

    // Apply to current window
    window.updateLocalTime = noop;
    window.checkTime = noop;
    window.startTimer = noop;
    window.checkAndShowPauseStudentAlert = noop;
    
    // Reach into parent if in iframe
    try {
        if (window.parent) {
            window.parent.checkAndShowPauseStudentAlert = noop;
            window.parent.startTimer = noop;
        }
    } catch(e) {}

    // Lock variables permanently
    try {
        Object.defineProperties(window, {
            'doneForDay': { get: () => false, set: () => {}, configurable: false },
            'availSeconds': { get: () => 99999, set: () => {}, configurable: false },
            'idleTime': { get: () => 0, set: () => {}, configurable: false }
        });
    } catch(e) {}

    // --- 3. SMART FIREWALL ---
    const originalOpen = window.XMLHttpRequest.prototype.open;
    window.XMLHttpRequest.prototype.open = function(method, url) {
        this._url = url;
        return originalOpen.apply(this, arguments);
    };

    const originalSend = window.XMLHttpRequest.prototype.send;
    window.XMLHttpRequest.prototype.send = function(body) {
        if (this._url && (this._url.includes("updateBasecamp") || this._url.includes("PauseData"))) {
            Object.defineProperty(this, 'readyState', {get: () => 4});
            Object.defineProperty(this, 'status', {get: () => 200});
            Object.defineProperty(this, 'responseText', {get: () => '{"valid":true,"authorized":true,"timeRemaining":99999,"studentPaused":false,"doneForDay":false}'});
            this.dispatchEvent(new Event('load'));
            return;
        }
        return originalSend.apply(this, arguments);
    };

    // --- 4. THE WATCHDOG
    // We only run these when the page actually changes, not on a timer.
    const observer = new MutationObserver(() => {
        boostFPS();
        const el = document.getElementById('aTimeData');
        if (el && el.innerText !== "2:00") {
            el.innerText = "2:00";
            document.getElementById('tTimeData').innerText = "999";
        }
    });
    observer.observe(document.documentElement, { childList: true, subtree: true });

    window.addEventListener('load', () => {
        console.log("%c[Sigma] Phantom v46: Lag-Free Mode Active", "color: #00FF00; font-weight: bold;");
        boostFPS();
    });

})();
